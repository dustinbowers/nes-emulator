<html lang="en">
<head>
    <meta charset="utf-8">
    <title>NES Emulator</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
        }
        canvas {
            width: 100%;
            height: 100%;
            position: absolute;
            margin: 0;
            padding: 0;
        }
        #run-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            flex-direction: column;
        }
    </style>
</head>
<body>

<canvas id="glcanvas" tabindex="1" hidden></canvas>

<script src="macroquad.js"></script>
<script type="module">
    import init, { set_wasm, trigger_reset, trigger_load, set_rom_data } from "./nes-emulator.js";

    let ROM_DATA = null;
    let wasmReady = false;
    let wbg = null;

    window.play_rom_url = async function(url) {
        console.log("[iframe] play_rom:", url);

        if (!wasmReady) {
            console.warn("[iframe] play_rom() called before WASM ready. Retrying...");
            await waitUntilReady();
        }

        await loadRom(url);
        startNES();
    };

    window.play_rom_bytes = async function(bytes) {
        console.log("[iframe] play_rom_bytes, length =", bytes.length);

        if (!wasmReady) {
            console.warn("[iframe] play_rom_bytes() called before WASM ready. Retrying...");
            await waitUntilReady();
        }

        // Load and start nes
        ROM_DATA = new Uint8Array(bytes);
        startNES();
    };

    async function waitUntilReady() {
        return new Promise(resolve => {
            const check = () => wasmReady ? resolve() : setTimeout(check, 20);
            check();
        });
    }

    async function loadRom(url) {
        const response = await fetch(url);
        const arrayBuffer = await response.arrayBuffer();
        ROM_DATA = new Uint8Array(arrayBuffer);
        console.log("[iframe] ROM loaded:", ROM_DATA.length, "bytes");
    }

    function startNES() {
        if (!ROM_DATA) return console.error("ROM_DATA missing");
        set_rom_data(ROM_DATA);
        trigger_reset();
        trigger_load();
    }

    async function start() {
        console.log("[iframe] initializing WASM…");

        wbg = await init();

        // Plugin describing Rust → JS bindings
        miniquad_add_plugin({
            register_plugin: (a) => {
                a.wbg = wbg;
            },
            on_init: () => {
                console.log("[iframe] miniQuad plugin init");
                set_wasm(wasm_exports);
                wasmReady = true;
            },
            version: "0.0.1",
            name: "wbg",
        });

        load("nes-emulator_bg.wasm");
    }

    window.run = async function () {
        document.getElementById("run-container")?.remove();
        document.getElementById("glcanvas").hidden = false;
        await start();
    };

    window.onload = () => window.run();
</script>

<div id="run-container">
    <button onclick="run()">Run Emulator</button>
</div>
</body>
</html>
