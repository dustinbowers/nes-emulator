<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>NES Emulator</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: sans-serif;
        }
        .controls {
            margin: 10px 0;
        }
        button {
            margin-right: 10px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
        }
        #rom-input {
            display: none;
        }
        #nes_canvas {
            display: block;
            margin-top: 10px;
            border: 1px solid #ccc;
            width: 512px;
            height: 512px;
        }
    </style>
</head>
<body>
<h1>NES Emulator</h1>
<div class="controls">
    <button id="load-rom-btn">Load ROM</button>
    <button id="pause-btn">Pause</button>
    <input type="file" id="rom-input" accept=".nes">
</div>
<canvas id="nes_canvas"></canvas>

<script type="module">
    import init, { start_audio } from './nes-emulator.js';

    console.log("Starting WASM init...");
    await init();
    console.log("WASM initialized");

    const loadRomBtn = document.getElementById("load-rom-btn");
    const romInput = document.getElementById("rom-input");

    // load rom button
    loadRomBtn.addEventListener("click", () => {
        start_audio();
        romInput.click();
    });

    // file selection
    romInput.addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        try {
            const arrayBuffer = await file.arrayBuffer();
            const romData = new Uint8Array(arrayBuffer);

            window.postMessage({
                type: "LoadRom",
                rom: Array.from(romData)
            }, "*");

            console.log(`Loaded ROM: ${file.name} (${romData.length} bytes)`);
        } catch (error) {
            console.error("Failed to load ROM:", error);
        }
    });

    // pause button
    const pauseBtn = document.getElementById("pause-btn");
    pauseBtn.addEventListener("click", () => {
        window.postMessage({
            type: "Pause"
        }, "*");
        console.log("Sent Pause message");
    });
</script>
</body>
</html>